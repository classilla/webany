#include <fcntl.h>
#include <stdio.h>
#include <signal.h>
#include <stdarg.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <termios.h>
#include <sys/select.h>

int porta;
struct termios ttya, ttya_saved;
struct sigaction hothotsig;
fd_set master;

void
usend(int j,...)
{
	size_t i=0;
	int rv;
	fd_set wfd;
	va_list ap;
	char d;

	va_start(ap, j);

	fprintf(stderr, "-- sending --\n");
	for(;;) {
		wfd=master;
		rv = select(porta+1, NULL, &wfd, NULL, NULL);
		if (rv < 0) {
			perror("select(send)");
			exit(255);
		}
		if (rv > 0) break;
	}
	for(i=0;i<j;i++) {
		char c = (char)va_arg(ap, int);
		fprintf(stderr, " %02x ", c);
		write(porta, &c, 1);
	}
	fprintf(stderr, "\n");
}

void
uwait(char c)
{
	fd_set rfd;
	struct timeval tv;
	char d;
	int rv;

	tv.tv_sec = 5;
	tv.tv_usec = 0;

	fprintf(stderr, "-- waiting for %02x:", c);
	for(;;) {
		for(;;) {
			rfd=master;
			rv = select(porta+1, &rfd, NULL, NULL, &tv);
			if (rv < 0) {
				perror("select(send)");
				exit(255);
			}
			if (rv == 0) {
				if (tv.tv_sec > 0 || tv.tv_usec > 0) continue;
				perror("timeout on select");
				exit(255);
			}
			if (rv > 0) break;
		}
		read(porta, &d, 1);
		fprintf(stderr, " %02x ", d);
		if (d == c) {
			fprintf(stderr, "--\n");
			return;
		}
	}
	fprintf(stderr, "unreachable\n"); exit(255);
}

void
cleanup()
{
	(void)tcsetattr(porta, TCSAFLUSH, &ttya_saved);
	(void)close(porta);
}

void
hotsigaction(int hotsig)
{
	fprintf(stdout, "\n\nexiting on signal\n");
	cleanup();
	exit(0);
}

int
main(int argc, char **argv)
{
	fd_set rfd, wfd;
	struct timeval tv;
	unsigned char c;
	int i;

	if (argc == 2)
		porta = open(argv[1], O_RDWR | O_NOCTTY);
	else
		porta = open("/dev/ttyUSB0", O_RDWR | O_NOCTTY);
	if (tcgetattr(porta, &ttya_saved)) {
		perror("tcgetattr (A)");
		close(porta);
		return 1;
	}

	atexit(cleanup);
	(void)memset(&hothotsig, 0, sizeof(hothotsig));
	hothotsig.sa_handler = hotsigaction;
	sigaction(SIGINT, &hothotsig, NULL);
	sigaction(SIGTERM, &hothotsig, NULL);
	sigaction(SIGHUP, &hothotsig, NULL);

	memset(&ttya, 0, sizeof(ttya));
	ttya.c_cflag = (CS8 | CREAD | CLOCAL);
ttya.c_cflag |= (PARENB | CSTOPB); /* 9600bps 8E2 no flow control */
	ttya.c_cc[VTIME] = 5;
	ttya.c_cc[VMIN] = 1;
	cfsetospeed(&ttya, B9600);
	cfsetispeed(&ttya, B9600);
	tcsetattr(porta, TCSANOW, &ttya);

	FD_ZERO(&master);
	FD_SET(porta, &master);
	tv.tv_sec = 0;
	tv.tv_usec = 0;

	setvbuf(stdout, NULL, _IONBF, 0); /* select(STDOUT); $|++; */

fprintf(stderr, "port open, sending in 5 seconds\n");
sleep(5);

/* encoding test
 * record 1: 

abcdefghijklmnopqrstuvwxyz
ABCDEFGHIJKLMNOPQRSTUVWXYZ
0123456789
`~!@#$%`&*()-_=+[{]}\|;:'",<.>/?

abcdefghijklmnopqrstuvwxyz`ABCDEFGHIJKLMNOPQRSTUVWXYZ`0123456789``~!@#$%`&*()-_=+[{]}\|;:'",<.>/?
(95 length)

 * record 2:

abcdefghijklmnopqrstuvwxyz
ABCDEFGHIJKLMNOPQRSTUVWXYZ
0123456789
`~!@#$%`&*()-_=+[{]}\|;:'",<.>/?

abcdefghijklmnopqrstuvwxyz (0d0a)
ABCDEFGHIJKLMNOPQRSTUVWXYZ (0d0a)
0123456789 (0d0a)
`~!@#$%`&*()-_=+[{]}\|;:'",<.>/?
(98 length)

*/
usend(10,           /* 213 length */    /* 2 packets */ /* header checksum: 214 */
0xAA, 0x55, 0x00, 0x00, 0x00, 0xD5, 0x00, 0x00, 0x02, 0xD6);
uwait(0xAA);

usend(129,
/* record separator: 0x01
 * line separator: 0x02 (`)
 * end of record: 0x00
 * 0-9: 0x50 - 0x59
 *  A B C D E F G H I J K L M N O P Q R S T U V W X Y Z
 * 060c0e12141a1c1e202426282a2c2e333537393c3e434547494b
 *  a b c d e f g h i j k l m n o p q r s t u v w x y z
 * 080d1013161b1d1f212527292b2d303436383a3d404446484a4c
 *  ` ~ ! @ # $ % ` & * ( ) - _ = + [ { ] } \ | ; : ' " , < . > / ?
 * 02724e4d775a5b025c605e5f666e67616a6f6c71687065645d4f627863797069
 *
 */
/* e     n     c     o     d     i     n     g   SP      t */
0x16, 0x2D, 0x10, 0x30, 0x13, 0x21, 0x2D, 0x1D, 0x05, 0x3D,
/* e     s     t   RS */
0x16, 0x3A, 0x3D, 0x01, 

/* a-z + LS */
0x08, 0x0D, 0x10, 0x13, 0x16, 0x1B,
0x1D, 0x1F, 0x21, 0x25, 0x27, 0x29, 0x2B, 0x2D, 0x30, 0x34,
0x36, 0x38, 0x3A, 0x3D, 0x40, 0x44, 0x46, 0x48, 0x4A, 0x4C,
0x02,

/* A-Z + LS */
0x06, 0x0C, 0x0E, 0x12, 0x14, 0x1A, 0x1C, 0x1E, 0x20,
0x24, 0x26, 0x28, 0x2A, 0x2C, 0x2E, 0x33, 0x35, 0x37, 0x39,
0x3C, 0x3E, 0x43, 0x45, 0x47, 0x49, 0x4B, 0x02,

/* 0-9 + LS */
0x50, 0x51,
0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x02,

/* ` ~ ! @ # $ % ` & * ( ) - _ = + [ { ] } \ | ; : ' " , < . > / ? */
0x02,
0x72, 0x4E, 0x4D, 0x77, 0x5A, 0x5B, 0x02, 0x5C, 0x60, 0x5E,
0x5F, 0x66, 0x6E, 0x67, 0x61, 0x6A, 0x6F, 0x6C, 0x71, 0x6B,
0x70, 0x65, 0x64, 0x5D, 0x4F, 0x62, 0x78, 0x63, 0x79, 0x70,
0x69,

/* RS */
0x01,

/* length of the above: 112 */

/* a b c d e f g h
 * i j k l m n o p + checksum */
0x08, 0x0D, 0x10, 0x13, 0x16, 0x1B, 0x1D, 0x1F,
0x21, 0x25, 0x27, 0x29, 0x2B, 0x2D, 0x30, 0x34, 0xEC); /* 16 + checksum */
uwait(0xAA);

usend(129,
/* q r s t u v w x y z */
0x36, 0x38, 0x3A, 0x3D, 0x40, 0x44, 0x46, 0x48, 0x4A, 0x4C,
/* CR LF (seen as b + nothing ) A B C D E F G H */
0x0D, 0x0A, 0x06, 0x0C, 0x0E, 0x12, 0x14, 0x1A, 0x1C, 0x1E,
/* I J K L M N O P Q R */
0x20, 0x24, 0x26, 0x28, 0x2A, 0x2C, 0x2E, 0x33, 0x35, 0x37,
/* S T U V W X Y Z CR LF */
0x39, 0x3C, 0x3E, 0x43, 0x45, 0x47, 0x49, 0x4B, 0x0D, 0x0A,
/* 0 1 2 3 4 5 6 7 8 9 */
0x50, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59,

/* CR LF, symbols */
0x0D, 0x0A, 0x02, 0x72, 0x4E, 0x4D, 0x77, 0x5A, 0x5B, 0x02,
0x5C, 0x60, 0x5E, 0x5F, 0x66, 0x6E, 0x67, 0x61, 0x6A, 0x6F,
0x6C, 0x71, 0x6B, 0x70, 0x65, 0x64, 0x5D, 0x4F, 0x62, 0x78,
0x63, 0x79, 0x70, 0x69,

/* EOR */
0x00, /* 101 */

/* padding? */
0x5B, 0x02, 0x5C, 0x60, 0x5E,
0x5F, 0x66, 0x6E, 0x67, 0x61, 0x6A, 0x6F, 0x6C, 0x71, 0x6B,
0x70, 0x65, 0x64, 0x5D, 0x4F, 0x62, 0x78, 0x63, 0x79, 0x70,
0x69, 0x01, 0x08, 0x0D, 0x10, 0x13, 0x16, 0x1B, 0x1D, 0x1F,
/* checksum 106 */
0x21, 0x25, 0x27, 0x29, 0x2B, 0x2D, 0x30, 0x34, 0x6A);
uwait(0xAA);

/* gopher.floodgap.com
 * record 1:

ETAOIN shrdlu CMFWYP vbgkqj XZ!

etaoin SHRDLU cmfwyp VBGKQJ xz?

 * record 2:

The quick brown fox jumps over the lazy dog.

The quick brown fox jumps over the lazy dog.

 * record 3:

test

test

*/

usend(10,
/* 102 length in one packet, header checksum 102 */
0xAA, 0x55, 0x00, 0x00, 0x00, 0x66, 0x00, 0x00, 0x01, 0x66);
uwait(0xAA);

usend(129,
/* g     o     p     h     e     r     .    f      l     o */
0x1D, 0x30, 0x34, 0x1F, 0x16, 0x38, 0x63, 0x1B, 0x29, 0x30,
/* o     d     g     a     p     .     c     o     m   RS  */
0x30, 0x13, 0x1D, 0x08, 0x34, 0x63, 0x10, 0x30, 0x2B, 0x01,
/* e     t     a     o     i     n   SP      S     H     R */
0x16, 0x3D, 0x08, 0x30, 0x21, 0x2D, 0x05, 0x39, 0x1E, 0x37,
/* D     L     U   SP      c     m     f     w     y     p */
0x12, 0x28, 0x3E, 0x05, 0x10, 0x2B, 0x1B, 0x46, 0x4A, 0x34,
/*SP     V     B     G     K     Q     J   SP      x     z */
0x05, 0x43, 0x0C, 0x1C, 0x26, 0x35, 0x24, 0x05, 0x48, 0x4C,

/* ?   RS */
0x69, 0x01,

/* The quick brown fox jumps over the lazy dog. */
0x3C, 0x1F, 0x16, 0x05, 0x36, 0x40, 0x21, 0x10,
0x27, 0x05, 0x0D, 0x38, 0x30, 0x46, 0x2D, 0x05, 0x1B, 0x30,
0x48, 0x05, 0x25, 0x40, 0x2B, 0x34, 0x3A, 0x05, 0x30, 0x44,
0x16, 0x38, 0x05, 0x3D, 0x1F, 0x16, 0x05, 0x29, 0x08, 0x4C,
0x4A, 0x05, 0x13, 0x30, 0x1D, 0x63, 0x01,

/* test */
0x3D, 0x16, 0x3A, 0x3D,

0x00, /* 102 */

/* padding? w  '  " */
0x64, 0x5D, 0x4F, 0x62, 0x78, 0x63, 0x79, 0x70,
0x69, 0x01, 0x08, 0x0D, 0x10, 0x13, 0x16, 0x1B, 0x1D, 0x1F,
/* checksum 37 */
0x21, 0x25, 0x27, 0x29, 0x2B, 0x2D, 0x30, 0x34, 0x25);
uwait(0xAA);

/* length and records test
 * three records, each 128 bytes, title 23 bytes
 *
 * record 1:

B123456789 123456789 223456789 323456789 423456789 523456789 623456789 723456789 823456789 923456789 023456789 123456789 2345678

 * record 2:

A123456789 123456789 223456789 323456789 423456789 523456789 623456789 723456789 823456789 923456789 023456789 123456789 2345678

 * record 3:

0123456789 123456789 223456789 323456789 423456789 523456789 623456789 723456789 823456789 923456789 023456789 123456789 2345678

*/

usend(10,
/* 411 length in 4 packets, header checksum 159 */
0xAA, 0x55, 0x00, 0x00, 0x01, 0x9B, 0x00, 0x00, 0x04, 0x9F);
uwait(0xAA);

usend(129,
/* 23 bytes, 24 with RS */
/* l     e     n     g     t     h   SP      a     n     d */
0x29, 0x16, 0x2D, 0x1D, 0x3D, 0x1F, 0x05, 0x08, 0x2D, 0x13,
/*SP     r     e     c     o     r     d     s   SP      t */
0x05, 0x38, 0x16, 0x10, 0x30, 0x38, 0x13, 0x3A, 0x05, 0x3D,
/* e     s     t   RS */
0x16, 0x3A, 0x3D, 0x01,

/* B123456789 ... (128 bytes, 129 with RS) */
0x0C, 0x51, 0x52, 0x53, 0x54, 0x55,
0x56, 0x57, 0x58, 0x59, 0x05, 0x51, 0x52, 0x53, 0x54, 0x55,
0x56, 0x57, 0x58, 0x59, 0x05, 0x52, 0x52, 0x53, 0x54, 0x55,

0x56, 0x57, 0x58, 0x59, 0x05, 0x53, 0x52, 0x53, 0x54, 0x55,
0x56, 0x57, 0x58, 0x59, 0x05, 0x54, 0x52, 0x53, 0x54, 0x55,
0x56, 0x57, 0x58, 0x59, 0x05, 0x55, 0x52, 0x53, 0x54, 0x55,
0x56, 0x57, 0x58, 0x59, 0x05, 0x56, 0x52, 0x53, 0x54, 0x55,
0x56, 0x57, 0x58, 0x59, 0x05, 0x57, 0x52, 0x53, 0x54, 0x55,

0x56, 0x57, 0x58, 0x59, 0x05, 0x58, 0x52, 0x53, 0x54, 0x55,
0x56, 0x57, 0x58, 0x59, 0x05, 0x59, 0x52, 0x53, 0x54, 0x55,
/* checksum 83 */
0x56, 0x57, 0x58, 0x59, 0x05, 0x50, 0x52, 0x53, 0x53);
uwait(0xAA);

usend(129,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x51, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x52, 0x53, 0x54,
0x55, 0x56, 0x57, 0x58, 0x01,

/* A123456789 ... (128 bytes) */
0x06, 0x51, 0x52, 0x53, 0x54,
0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x51, 0x52, 0x53, 0x54,
0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x52, 0x52, 0x53, 0x54,

0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x53, 0x52, 0x53, 0x54,
0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x54, 0x52, 0x53, 0x54,
0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x55, 0x52, 0x53, 0x54,
0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x56, 0x52, 0x53, 0x54,
0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x57, 0x52, 0x53, 0x54,

0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x58, 0x52, 0x53, 0x54,
0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x59, 0x52, 0x53, 0x54,
/* checksum 66 */
0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x50, 0x52, 0x42);
uwait(0xAA);

usend(129,
0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x51, 0x52,
0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x01,

/* 0123456789 ... (128 bytes) */
0x50, 0x51, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x51, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x52, 0x52, 0x53,

0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x53, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x54, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x55, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x56, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x57, 0x52, 0x53,

0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x58, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x59, 0x52, 0x53,
/* checksum 141 */
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x50, 0x8D);
uwait(0xAA);

usend(129,
0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x51,
0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x52,
0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x00,

/* padding? */
0x51, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x51, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x52, 0x52, 0x53,

0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x53, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x54, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x55, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x56, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x57, 0x52, 0x53,

0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x58, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x59, 0x52, 0x53,
/* checksum 142 */
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x50, 0x8E);
uwait(0xAA);

/* www.floodgap.com
 *
 * record 1:

etaoin SHRDLU cmfwyp VBGKQJ xz?

 * record 2:

The quick brown fox jumps over the lazy dog.

*/

usend(10,
/* 94 length in one packet, header checksum 94 */
0xAA, 0x55, 0x00, 0x00, 0x00, 0x5E, 0x00, 0x00, 0x01, 0x5E);
uwait(0xAA);

usend(129,
/* w     w     w     .     f     l     o     o     d     g */
0x46, 0x46, 0x46, 0x63, 0x1B, 0x29, 0x30, 0x30, 0x13, 0x1D,
/* a     p     .     c     o     m   RS */
0x08, 0x34, 0x63, 0x10, 0x30, 0x2B, 0x01,

0x16, 0x3D, 0x08,
0x30, 0x21, 0x2D, 0x05, 0x39, 0x1E, 0x37, 0x12, 0x28, 0x3E,
0x05, 0x10, 0x2B, 0x1B, 0x46, 0x4A, 0x34, 0x05, 0x43, 0x0C,
0x1C, 0x26, 0x35, 0x24, 0x05, 0x48, 0x4C, 0x69, 0x01,

0x3C,
0x1F, 0x16, 0x05, 0x36, 0x40, 0x21, 0x10, 0x27, 0x05, 0x0D,
0x38, 0x30, 0x46, 0x2D, 0x05, 0x1B, 0x30, 0x48, 0x05, 0x25,
0x40, 0x2B, 0x34, 0x3A, 0x05, 0x30, 0x44, 0x16, 0x38, 0x05,
0x3D, 0x1F, 0x16, 0x05, 0x29, 0x08, 0x4C, 0x4A, 0x05, 0x13,
0x30, 0x1D, 0x63, 0x00, /* 94 */

/* padding? */
0x58, 0x59, 0x05, 0x57, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x58, 0x52, 0x53,
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x59, 0x52, 0x53,
/* checksum 200 */
0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x05, 0x50, 0xC8);
uwait(0xAA);

/* end of transmission */
usend(10,
/* no length no packets checksum always 254 */
0xAA, 0x55, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE);
uwait(0xAA);

	fprintf(stderr, "\nok\n");
	return 0;
}
